var USDAControllers=angular.module("usdaControllers",["mm.foundation","ngMap","chart.js","ngAnimate"]);USDAControllers.factory("locationService",["$http","$q",function(e,t){var a=function(s){var o={};o.method="JSONP",o.url="http://dev.virtualearth.net/REST/v1/Locations?output=json&jsonp=JSON_CALLBACK&CountryRegion=US&adminDistrict="+s+"&key=AgRH1NfLoOiOYRppfNJv6JAbhhnTEmXIoxjKvb7c0-AOC3s-Zo8rVIMGouCobWDx";var r={lat:"",lng:""},n=t.defer();return e(o).success(function(e){var t=angular.fromJson(e);null==t.resourceSets[0].resources[0]?(console.log("Missed "+s),a(s).then(function(e){n.resolve(e)})):null!==t.resourceSets[0].resources[0].point?(r.lat=t.resourceSets[0].resources[0].point.coordinates[0],r.lng=t.resourceSets[0].resources[0].point.coordinates[1],n.resolve(r)):null!==t.resourceSets[0].resources[0].geocodePoints&&(r.lat=t.resourceSets[0].resources[0].geocodePoints.coordinates[0],r.lng=t.resourceSets[0].resources[0].geocodePoints.coordinates[1],console.log(r),n.resolve(r))}).error(function(e,t){console.log(t),n.reject(t)}),n.promise};return{getStateLatLng:function(e){return a(e)}}}]),USDAControllers.factory("stateService",["$http","$q",function(e,t){var a=function(){var e={alabama:{points:0,data:0,set:0,hit:0},alaska:{points:0,data:0,set:0,hit:0},arizona:{points:0,data:0,set:0,hit:0},arkansas:{points:0,data:0,set:0,hit:0},california:{points:0,data:0,set:0,hit:0},colorado:{points:0,data:0,set:0,hit:0},connecticut:{points:0,data:0,set:0,hit:0},delaware:{points:0,data:0,set:0,hit:0},florida:{points:0,data:0,set:0,hit:0},georgia:{points:0,data:0,set:0,hit:0},hawaii:{points:0,data:0,set:0,hit:0},idaho:{points:0,data:0,set:0,hit:0},illinois:{points:0,data:0,set:0,hit:0},indiana:{points:0,data:0,set:0,hit:0},iowa:{points:0,data:0,set:0,hit:0},kansas:{points:0,data:0,set:0,hit:0},kentucky:{points:0,data:0,set:0,hit:0},louisiana:{points:0,data:0,set:0,hit:0},maine:{points:0,data:0,set:0,hit:0},maryland:{points:0,data:0,set:0,hit:0},massachusetts:{points:0,data:0,set:0,hit:0},michigan:{points:0,data:0,set:0,hit:0},minnesota:{points:0,data:0,set:0,hit:0},mississippi:{points:0,data:0,set:0,hit:0},missouri:{points:0,data:0,set:0,hit:0},montana:{points:0,data:0,set:0,hit:0},nebraska:{points:0,data:0,set:0,hit:0},nevada:{points:0,data:0,set:0,hit:0},new_hampshire:{points:0,data:0,set:0,hit:0},new_jersey:{points:0,data:0,set:0,hit:0},new_mexico:{points:0,data:0,set:0,hit:0},new_york:{points:0,data:0,set:0,hit:0},north_carolina:{points:0,data:0,set:0,hit:0},north_dakota:{points:0,data:0,set:0,hit:0},ohio:{points:0,data:0,set:0,hit:0},oklahoma:{points:0,data:0,set:0,hit:0},oregon:{points:0,data:0,set:0,hit:0},pennsylvania:{points:0,data:0,set:0,hit:0},rhode_island:{points:0,data:0,set:0,hit:0},south_carolina:{points:0,data:0,set:0,hit:0},south_dakota:{points:0,data:0,set:0,hit:0},tennessee:{points:0,data:0,set:0,hit:0},texas:{points:0,data:0,set:0,hit:0},utah:{points:0,data:0,set:0,hit:0},vermont:{points:0,data:0,set:0,hit:0},virginia:{points:0,data:0,set:0,hit:0},washington:{points:0,data:0,set:0,hit:0},west_virginia:{points:0,data:0,set:0,hit:0},wisconsin:{points:0,data:0,set:0,hit:0},wyoming:{points:0,data:0,set:0,hit:0}};return{getClean:function(){return e}}},s=null,o=function(a){var s={},o={};o.method="GET",o.url="http://nass-api.azurewebsites.net/api/api_get?agg_level_desc=STATE";for(var r=Object.keys(a),n=0;n<r.length;n++)o.url+="&",o.url+=r[n]+"="+a[r[n]];var i=t.defer();return e(o).success(function(e){return s=angular.fromJson(e),i.resolve(s),i.promise}).error(function(e,t){console.log(t),i.reject(t)}),i.promise},r=function(a){var s=[],o={};o.method="GET",o.headers={Authorization:"Basic "+btoa("wW7wO99BMioS0cs/J+bsL1VF/Pa/qfNduvR9vr/L5rg:wW7wO99BMioS0cs/J+bsL1VF/Pa/qfNduvR9vr/L5rg")},o.url="https://api.datamarket.azure.com/Bing/Search/v1/Image?$format=JSON&Query=%27"+a+"%20landscape%27&Adult=%27Moderate%27&ImageFilters=%27Size%3AMedium%2BAspect%3AWide%27";var r=t.defer();return e(o).success(function(e){s.push(e.d.results[0].Thumbnail.MediaUrl),s.push(e.d.results[1].Thumbnail.MediaUrl),r.resolve(s)}).error(function(e,t){console.log(t),r.reject(t)}),r.promise},n=function(a){var s=[],o={};o.method="GET",o.headers={Authorization:"Basic "+btoa("wW7wO99BMioS0cs/J+bsL1VF/Pa/qfNduvR9vr/L5rg:wW7wO99BMioS0cs/J+bsL1VF/Pa/qfNduvR9vr/L5rg")},o.url="https://api.datamarket.azure.com/Bing/Search/v1/Web?$format=json&Query=%27"+a+"%20state%20wikipedia%27";var r=t.defer();return e(o).success(function(e){for(var t=0;t<e.d.results.length;t++)if(-1===e.d.results[t].Title.indexOf("University")){var o=e.d.results[t].Description;o=o.substring(0,a.length)+" "+o.substring(o.indexOf("is")),-1!==o.indexOf("...")&&(o=o.substring(0,o.indexOf("...")-1)),s.push(o),s.push(e.d.results[t].Url),r.resolve(s);break}}).error(function(e,t){console.log(t),r.reject(t)}),r.promise};return{getStateData:function(e){return o(e)},getImages:function(e){return r(e)},getWikipediaInformation:function(e){return n(e)},getStates:function(){return s},resetStates:function(){s=null,temp=new a,s=temp.getClean()}}}]),USDAControllers.factory("mathService",function(){var e=function(e){for(var t=0,a=e.data,s=0;s<a.length;s++){var o=parseFloat(a[s].value);t+=o}var r=t/a.length;return Math.floor(r)},t=function(e){var t=e.data;return t.sort(function(e,t){return parseFloat(e.value)-parseFloat(t.value)}),e},a=function(e){var t=e;return t.sort(function(e,t){return parseFloat(e.points)-parseFloat(t.points)}),e};return{getAverage:function(t){return e(t)},sortData:function(e){return t(e)},sortArray:function(e){return a(e)}}}),USDAControllers.factory("dataService",["stateService",function(e){var t=function(e){for(var t=0,a=e.length-1;a>=0;a--)0===Object.keys(e[a]).length&&(e.splice(a,1),t++);return t},a=function(e){for(var t=e.data.length-1;t>=0;t--)("(S)"===e.data[t].value||"(D)"===e.data[t].value)&&e.data.splice(t,1)},s=function(e){for(var t=0;t<e.data.length;t++)if("string"==typeof e.data[t].value||e.data[t].value instanceof String)for(;-1!==e.data[t].value.indexOf(",");)e.data[t].value=e.data[t].value.replace(",","")},o=function(e){for(var t=0;t<e.data.length;t++)parseFloat(e.data[t].average)>1e9?(e.data[t].value=parseFloat(e.data[t].value)/1e9,e.data[t].average=parseFloat(e.data[t].average)/1e9,e.data[t].unit_desc+=" (Billions)"):parseFloat(e.data[t].average)>1e6&&(e.data[t].value=parseFloat(e.data[t].value)/1e6,e.data[t].average=parseFloat(e.data[t].average)/1e6,e.data[t].unit_desc+=" (Millions)")},r=function(e,t){for(var a=0;a<e.data.length;a++)e.data[a].average=t},n=function(e){for(var t=0;t<e.data.length;t++)e.data[t].points=t+1},i=!1,c=0,l=function(){return i=i===!1?!0:!1},d=function(t,a){var s=e.getStates();s[t].set++,s[t].set>c&&(console.log(t),console.log(a))},u=function(t){var a=e.getStates();a[t].hit++},p=function(t){for(var a=e.getStates(),s=Object.keys(a),o=0;o<s.length;o++)1!==a[s[o]].hit&&(a[s[o]].points+=Math.round(t/2),a[s[o]].hit++);for(var o=0;o<s.length;o++)a[s[o]].hit=0},h=function(){for(var t=e.getStates(),a=Object.keys(t),s=0;s<a.length;s++)t[a[s]].set=0};return{removeEmpties:function(e){return t(e)},removeBadData:function(e){return a(e)},removeComma:function(e){return s(e)},reduceValue:function(e){return o(e)},addAverage:function(e,t){return r(e,t)},addPoints:function(e){return n(e)},toggleLoading:function(){return l()},trackData:function(e,t){return d(e,t)},addHit:function(e){return u(e)},addPointsReset:function(e){return p(e)},resetTrackData:function(){return h()},setYear:function(e){c=e}}}]),USDAControllers.controller("HomeCtrl",["$scope","$q","$http","$timeout","stateService","mathService","locationService","dataService",function(e,t,a,s,o,r,n,i){var c={sector_desc:"ECONOMICS",group_desc:"EXPENSES",commodity_desc:"RENT",class_desc:"CASH%2C%20CROPLAND",prodn_practice_desc:"IRRIGATED",year:""},l={sector_desc:"ECONOMICS",group_desc:"EXPENSES",commodity_desc:"RENT",class_desc:"CASH%2C%20CROPLAND",prodn_practice_desc:"NON-IRRIGATED",year:""},d={sector_desc:"ECONOMICS",group_desc:"EXPENSES",commodity_desc:"RENT",class_desc:"CASH%2C%20PASTURELAND",year:""},u={sector_desc:"ECONOMICS",group_desc:"EXPENSES",commodity_desc:"EXPENSE%20TOTALS",class_desc:"PRODUCTION",unit_desc:"$",year:""},p={sector_desc:"ECONOMICS",group_desc:"PRICES%20PAID",commodity_desc:"RENT",class_desc:"PER%20COW-CALF",year:""},h={sector_desc:"ECONOMICS",group_desc:"PRICES%20PAID",commodity_desc:"RENT",class_desc:"PER%20HEAD",year:""},g={sector_desc:"ECONOMICS",group_desc:"INCOME",commodity_desc:"INCOME%2C%20FARM-RELATED",class_desc:"FOREST%20PRODUCTS%2C%20(EXCL%20CHRISTMAS%20TREES%20%26%20SHORT%20TERM%20WOODY%20CROPS%20%26%20MAPLE%20SYRUP)",domain_desc:"TOTAL",unit_desc:"$",year:""},f={sector_desc:"ECONOMICS",group_desc:"INCOME",commodity_desc:"INCOME%2C%20FARM-RELATED",class_desc:"AG%20TOURISM%20%26%20RECREATIONAL%20SERVICES",domain_desc:"TOTAL",unit_desc:"$",year:""},m={sector_desc:"ECONOMICS",group_desc:"INCOME",commodity_desc:"INCOME%2C%20FARM-RELATED",class_desc:"GOVT%20PROGRAMS%2C%20STATE%20%26%20LOCAL",domain_desc:"TOTAL",unit_desc:"$",year:""},v={sector_desc:"ECONOMICS",group_desc:"INCOME",commodity_desc:"INCOME%2C%20FARM-RELATED",class_desc:"PATRONAGE%20DIVIDENDS%20%26%20REFUNDS%20FROM%20COOPERATIVES",domain_desc:"TOTAL",unit_desc:"$",year:""},S={sector_desc:"ECONOMICS",group_desc:"INCOME",commodity_desc:"GOVT%20PROGRAMS",class_desc:"FEDERAL",domain_desc:"TOTAL",unit_desc:"$",year:""};e.sets={expenses:{selected:"Expenses",sets:6,startingYear:1999,years:15,scoreDesc:"A lower score means that a state is less expensive for farming. Land is cheaper to buy, livestock is cheaper to maintain, and general expenses are low.",accuracyDesc:""},income:{selected:"Income",sets:5,startingYear:1999,years:15,scoreDesc:"A higher score means that a state earns more income in the agricultural district. More income is made from tourism, selling of christmas trees, etc.",accuracyDesc:""}},e.contextualInformation=null,e.loading=!1,e.states=[],e.stateSelected=!1,e.sortType="points",e.sortReverse=!1,e.max=0,e.selectedSetData=[],e.empties=0,e.charts=[],e.selectedState="",e.selectedStateData=[],e.stateDescription="",e.descriptionReference="",e.stateImageOne="",e.stateImageTwo="";var E=null,C=null;e.stateMarker={};var O=function(){o.resetStates(),e.states=[],e.stateSelected=!1,e.sortType="points",e.sortReverse=!1,e.max=0,e.selectedSetData=[],e.empties=0};e.compileEconomicExpenseData=function(){var a=[];O(),e.loading=i.toggleLoading(),i.setYear(e.years),e.sets.expenses.accuracyDesc="Compiled from "+e.sets.expenses.sets+" data sets over "+e.sets.expenses.years+" years. Less accuracy means less data was collected over the time period for that state.",e.contextualInformation=e.sets.expenses;var s=o.getStates();a.push(A(c)),a.push(A(l)),a.push(A(d)),a.push(A(u)),a.push(A(p)),a.push(A(h)),t.all(a).then(function(t){for(var a=0;a<t.length;a++){for(var o=0;o<t[a].length;o++){for(var n=0;n<t[a][o].data.length;n++){var c=t[a][o].data[n].state_name.toLowerCase().replace(" ","_");i.trackData(c,t[a][o]),i.addHit(c),s[c].points+=t[a][o].data[n].points,s[c].data++}i.addPointsReset(t[a][o].data.length)}i.resetTrackData()}e.selectedSetData=t,console.log(e.selectedSetData);for(var a=0;a<t.length;a++)e.max+=t[a].length;for(var l=Object.keys(s),a=0;a<l.length;a++)s[l[a]].state=l[a],e.states.push(s[l[a]]);r.sortArray(e.states);for(var a=0;a<e.states.length;a++)e.states[a].rank=a+1;e.loading=i.toggleLoading()})},e.compileEconomicIncomeData=function(){var a=[];O(),e.loading=i.toggleLoading(),i.setYear(e.years),e.sets.income.accuracyDesc="Compiled from "+e.sets.income.sets+" data sets over "+e.sets.income.years+" years. Less accuracy means less data was collected over the time period for that state.",e.contextualInformation=e.sets.income;var s=o.getStates();a.push(A(g)),a.push(A(f)),a.push(A(m)),a.push(A(v)),a.push(A(S)),t.all(a).then(function(t){for(var a=0;a<t.length;a++){for(var o=0;o<t[a].length;o++){for(var n=0;n<t[a][o].data.length;n++){var c=t[a][o].data[n].state_name.toLowerCase().replace(" ","_");i.trackData(c,t[a][o]),i.addHit(c),s[c].points+=t[a][o].data[n].points,s[c].data++}i.addPointsReset(t[a][o].data.length)}i.resetTrackData()}e.selectedSetData=t;for(var a=0;a<t.length;a++)e.max+=t[a].length;for(var l=Object.keys(s),a=0;a<l.length;a++)s[l[a]].state=l[a],e.states.push(s[l[a]]);r.sortArray(e.states);for(var a=0;a<e.states.length;a++)e.states[a].rank=a+1;e.loading=i.toggleLoading()})};var A=function(a){for(var s=[],n=t.defer(),c=e.contextualInformation.startingYear;c<e.contextualInformation.startingYear+e.contextualInformation.years;c++)a.year=c,s.push(o.getStateData(a));return t.all(s).then(function(t){e.empties=i.removeEmpties(t);for(var a=0;a<t.length;a++)i.removeBadData(t[a]),i.removeComma(t[a]),i.addAverage(t[a],r.getAverage(t[a])),i.reduceValue(t[a]),r.sortData(t[a]),i.addPoints(t[a]);n.resolve(t)}),n.promise};e.showStateData=function(t){if(e.loading=i.toggleLoading(),e.selectedState=t,e.stateSelected=!0,D(t),"Expenses"===e.contextualInformation.selected)for(var a={title:"",desc:"",unit:"",colors:["#0000A0","#FF7400"],labels:[],series:[],data:[[],[]],options:{scaleShowVerticalLines:!1}},s=0;s<e.selectedSetData.length;s++){a.series.push(t.toUpperCase().replace("_"," ")),a.series.push("US AVERAGE");for(var o=null,r=null,n=0;n<e.selectedSetData[s].length;n++){for(var c=null,l=null,d=null,u=!1,p=0;p<e.selectedSetData[s][n].data.length;p++){var h=e.selectedSetData[s][n].data[p].state_name.toLowerCase().replace(" ","_");if(t===h){r=e.selectedSetData[s][n].data[p],u=!0,c=e.selectedSetData[s][n].data[p].year,l=e.selectedSetData[s][n].data[p].value,d=e.selectedSetData[s][n].data[p].average,o=e.selectedSetData[s][n].data[p].unit_desc;break}}u&&(a.labels.push(c),a.data[0].push(l),a.data[1].push(d))}0!==a.labels.length&&(a.unit=o,_(a,r),console.log(a),e.charts.push(a)),a={title:"",desc:"",unit:"",colors:["#0000A0","#FF7400"],labels:[],series:[],data:[[],[]],options:{scaleShowVerticalLines:!1}}}else if("Income"===e.contextualInformation.selected)for(var a={title:"",desc:"",unit:"",colors:["#0000A0","#FF7400"],labels:[],series:[],data:[[],[]],options:{scaleShowVerticalLines:!1}},s=0;s<e.selectedSetData.length;s++){a.series.push(t.toUpperCase().replace("_"," ")),a.series.push("US AVERAGE");for(var o=null,r=null,n=0;n<e.selectedSetData[s].length;n++){for(var c=null,l=null,d=null,u=!1,p=0;p<e.selectedSetData[s][n].data.length;p++){var h=e.selectedSetData[s][n].data[p].state_name.toLowerCase().replace(" ","_");if(t===h){r=e.selectedSetData[s][n].data[p],u=!0,c=e.selectedSetData[s][n].data[p].year,l=e.selectedSetData[s][n].data[p].value,d=e.selectedSetData[s][n].data[p].average,o=e.selectedSetData[s][n].data[p].unit_desc;break}}u&&(a.labels.push(c),a.data[0].push(l),a.data[1].push(d))}0!==a.labels.length&&(a.unit=o,_(a,r),e.charts.push(a)),a={title:"",desc:"",unit:"",colors:["#0000A0","#FF7400"],labels:[],series:[],data:[[],[]],options:{scaleShowVerticalLines:!1}}}},e.hideStateData=function(){e.stateSelected=!1,e.charts=[],e.selectedState="",e.selectedStateData=[],e.stateDescription="",e.descriptionReference="",e.stateImageOne="",e.stateImageTwo="",e.stateMarker={}};var _=function(t,a){"Expenses"===e.contextualInformation.selected?"CASH, CROPLAND"===a.class_desc?"IRRIGATED"===a.prodn_practice_desc?(t.title="Cost of One Irrigated Farmland Acre per Month",t.desc="This is the cost to maintain and operate one acre of irrigated farmland per month. Even if the land is owned a lower number means that the land is cheaper."):"NON-IRRIGATED"===a.prodn_practice_desc&&(t.title="Cost of One Non-Irrigated Farmland Acre per Month",t.desc="This is the cost to maintain and operate one acre of non-irrigated farmland per month. Even if the land is owned a lower number means that the land is cheaper."):"CASH, PASTURELAND"===a.class_desc?(t.title="Cost of One Pastureland Acre per Month",t.desc="This is the cost to maintain and operate one acre of pastureland for livestock per month. Even if the land is owned a lower number means that the land is cheaper."):"PRODUCTION"===a.class_desc?(t.title="Total Production Costs Per Year",t.desc="This is the summative total of how much money farm operations spend per year. Consists of many things, land maintenance, taxes, livestock feed, etc."):"PER COW-CALF"===a.class_desc?(t.title="Cost of One Cow per Month",t.desc="The total cost to own and care for a cow or calf per month."):"PER HEAD"===a.class_desc&&(t.title="Cost of Any Livestock per Month",t.desc="The total cost to own and care for any livestock per month as an average between all common livestock."):"Income"===e.contextualInformation.selected&&("FOREST PRODUCTS, (EXCL CHRISTMAS TREES & SHORT TERM WOODY CROPS & MAPLE SYRUP)"===a.class_desc?(t.title="Total Earnings from Forest Products",t.desc="Total earnings from forest products. Does not include earnings from christmas trees, short woody crops, or maple syrup."):"AG TOURISM & RECREATIONAL SERVICES"===a.class_desc?(t.title="Total Earnings from Agricultural Tourism",t.desc="Agricultural tourism consists of tourists staying at a farm or ranch for any time period."):"GOVT PROGRAMS, STATE & LOCAL"===a.class_desc?(t.title="Total Earnings from State and Local Government Programs",t.desc="Total earnings from government programs that give incentives for the production of certain types of crops or reducing production of certain crops."):"PATRONAGE DIVIDENDS & REFUNDS FROM COOPERATIVES"===a.class_desc?(t.title="Total Earnings from Cooperatives",t.desc="A cooperative is a type of farm that is owned and run jointly by several members who all share profits."):"FEDERAL"===a.class_desc&&(t.title="Total Earnings from Federal Government Programs",t.desc="Total earnings from federally mandated government programs that give incentives for the production of certain types of crops or reducing production of certain crops."))},D=function(a){var r=o.getImages(a.replace("_"," ")),c=o.getWikipediaInformation(a.replace("_"," ")),l=n.getStateLatLng(a.replace("_","%20"));t.all([r,c,l]).then(function(t){e.loading=i.toggleLoading(),e.stateImageOne=t[0][0],e.stateImageTwo=t[0][1],e.stateDescription=t[1][0],e.descriptionReference=t[1][1],s(function(){google.maps.event.trigger(E,"resize"),google.maps.event.trigger(C,"resize"),E.setCenter(t[2]),C.setCenter(t[2]),e.stateMarker=t[2]},10)})};e.changeSortType=function(t){t===e.sortType?e.sortReverse=e.sortReverse===!1?!0:!1:(e.sortType=t,e.sortReverse=!1)},e.getTableColor=function(e){return e%2===1?!0:!1},e.getScoreMax=function(){return e.states[e.states.length-1].points},e.getScoreBarColor=function(t){var a=e.getScoreMax(),a=parseInt(a),t=parseInt(t),s=Math.floor(t/a*100);return"Expenses"===e.contextualInformation.selected?s>80?"alert":s>40&&80>=s?null:40>=s?"success":null:"Income"===e.contextualInformation.selected?s>80?"success":s>40&&80>=s?null:40>=s?"alert":null:void 0},e.getStateDataValue=function(){var t=o.getStates();return t[e.selectedState].data},e.getStateMax=function(){return e.max},e.getStatePercentage=function(){return Math.round(e.getStateDataValue()/e.getStateMax()*100)},e.$on("mapInitialized",function(t,a){null===E?(E=a,E.setCenter({lat:39,lng:89}),E.setZoom(6),E.setOptions(e.mapOptions)):(C=a,C.setCenter({lat:39,lng:89}),C.setZoom(6),C.setOptions(e.mapOptions))}),e.mapOptions={scrollwheel:!1,draggable:!1,disableDoubleClickZoom:!0,disableDefaultUI:!0,mapTypeId:google.maps.MapTypeId.HYBRID}}]);